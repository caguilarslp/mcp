# ü§ñ Contexto para Claude/Cursor - wAIckoff MCP Server v1.5.0 (PRODUCTION READY + CONFIGURATION SYSTEM)

## üéÜ ESTADO CR√çTICO v1.5.0 - TASK-010 CONFIGURACI√ìN TIMEZONE COMPLETADA
**‚úÖ SISTEMA CONFIGURACI√ìN PERSISTENTE**: Sistema completo de configuraci√≥n de usuario implementado
**‚úÖ AUTO-DETECCI√ìN TIMEZONE**: M√∫ltiples m√©todos de detecci√≥n inteligente cross-platform
**‚úÖ 7 NUEVAS HERRAMIENTAS MCP**: Sistema completo de gesti√≥n de configuraci√≥n
**‚úÖ FRICTION-FREE UX**: Elimina necesidad de especificar timezone en cada request
**‚úÖ FASTAPI READY**: Base s√≥lida para integraci√≥n multi-usuario
**üéØ SISTEMA COMPLETO**: An√°lisis ‚Üí Almacenamiento ‚Üí Reportes ‚Üí Tests ‚Üí Configuraci√≥n funcionando
**‚úÖ COMPILACI√ìN EXITOSA**: `npm run build` sin errores - sistema robusto y expandible
**üöÄ PRODUCTION READY**: Sistema listo para producci√≥n con todas las features + configuraci√≥n

## IMPORTANTE: Leer ANTES de dar cualquier sugerencia

### üìä SISTEMA DE TRAZABILIDAD COMPLETA v1.3.4 (OBLIGATORIO)
**‚ö†Ô∏è CAMBIO CR√çTICO**: Sistema de logging avanzado implementado - revisar documentaci√≥n de debugging
**SIEMPRE** revisar y actualizar estos archivos en orden de prioridad:

#### **üìã Archivos Cr√≠ticos de Estado:**
- `claude/master-log.md` - **Estado actual del MCP (LEER PRIMERO)**
- `claude/tasks/task-tracker.md` - Pr√≥ximas funciones a implementar
- `claude/bugs/` - **NUEVA** carpeta con bugs documentados y soluciones
- `claude/lessons-learned/` - **NUEVA** carpeta con lecciones aprendidas cr√≠ticas
- `claude/docs/` - **NUEVA** documentaci√≥n t√©cnica completa de features
- `claude/logs/YYYY-MM-DD.md` - Log diario (ACTUALIZAR al final)

#### **üìö Documentaci√≥n T√©cnica:**
- `claude/docs/architecture/system-overview.md` - **NUEVA** arquitectura completa
- `claude/docs/api/tools-reference.md` - **NUEVA** referencia de API
- `claude/docs/troubleshooting/common-issues.md` - **NUEVA** gu√≠a de resoluci√≥n
- `claude/docs/task-005-auto-save-system.md` - **NUEVA** documentaci√≥n auto-save
- `claude/docs/task-009-storage-system-complete.md` - **NUEVA** documentaci√≥n storage completo
- `claude/docs/timezone-system.md` - **NUEVA** documentaci√≥n sistema timezone
- `claude/docs/timezone-future-recommendations.md` - **NUEVA** recomendaciones timezone
- `claude/decisions/adr-log.md` - Decisiones arquitect√≥nicas
- `claude/lessons-learned/README.md` - **NUEVA** √≠ndice de lecciones aprendidas
- `claude/bugs/bug-004-storage-query-pattern.md` - **NUEVA** soluci√≥n pattern matching
- `ROADMAP_AVANZADO.md` - Visi√≥n general de funcionalidades futuras

#### **üêõ Gesti√≥n de Bugs:**
- **SISTEMA COMPLETO**: Todos los bugs cr√≠ticos se documentan en `claude/bugs/`
- **Formato**: `bug-XXX-description.md` con an√°lisis completo
- **Registro**: `claude/bugs/README.md` con √≠ndice y m√©tricas
- **Ejemplos**: BUG-001 (S/R classification), BUG-002 (Architecture refactor), BUG-004 (Storage pattern)

#### **üìö Gesti√≥n de Lecciones Aprendidas:**
- **SISTEMA NUEVO**: Todas las lecciones cr√≠ticas en `claude/lessons-learned/`
- **Formato**: `lesson-XXX-description.md` con an√°lisis y patterns
- **Registro**: `claude/lessons-learned/README.md` con √≠ndice y templates
- **Ejemplos**: LESSON-001 (Auto-save implementation failure)

### üéÜ ESTADO ACTUAL (v1.5.0 - 11/06/2025) - TASK-010 COMPLETADA
- **Fase:** ‚úÖ TASK-010 COMPLETADA - Sistema configuraci√≥n timezone persistente implementado
- **√öltima Actualizaci√≥n:** v1.5.0 con sistema completo de configuraci√≥n timezone
- **Pr√≥xima Decisi√≥n:** Iniciar TASK-017 (Sistema An√°lisis Hist√≥rico) - Base fundamental para an√°lisis
- **Bloqueadores:** NINGUNO - Sistema completo y funcional con configuraci√≥n
- **UX Status:** üéÜ COMPLETO - An√°lisis + Storage + Cache + Repository + Reports + Configuration
- **Funcionalidad:** ‚úÖ Sistema MCP completo 100% operativo + configuraci√≥n timezone friction-free

### üèóÔ∏è NUEVA ARQUITECTURA STORAGE SERVICE v1.3.8
**‚úÖ REFACTORIZACI√ìN MODULAR COMPLETA**: StorageService dividido en servicios especializados
**üîß BUG-004 RESUELTO**: Pattern matching cross-platform robusto
**üìÅ SEPARACI√ìN DE CONCERNS**: Cada servicio con responsabilidad √∫nica

#### **üìÇ Storage Service Architecture**
- ‚úÖ **FileSystemService** (`src/services/storage/fileSystemService.ts`)
  - Operaciones de bajo nivel: read, write, delete, walk
  - Manejo at√≥mico con archivos temporales
  - Error handling especializado
  
- ‚úÖ **PatternMatcher** (`src/services/storage/patternMatcher.ts`)
  - Conversi√≥n glob ‚Üí regex mejorada
  - Soporte `*` (single dir) y `**` (recursive)
  - Normalizaci√≥n consistente de paths
  
- ‚úÖ **StorageConfigService** (`src/services/storage/storageConfig.ts`)
  - Gesti√≥n centralizada de configuraci√≥n
  - Validaci√≥n de l√≠mites y constraints
  - Estructura de directorios predefinida
  
- ‚úÖ **StorageService** (`src/services/storage.ts`)
  - Orquestador de alto nivel
  - Delega a servicios especializados
  - API p√∫blica simplificada

### üéÜ ARQUITECTURA MODULAR v1.3.8 - COMPLETAMENTE OPERATIVA
**‚úÖ SISTEMA DE HANDLERS**: MCPHandlers + delegation pattern funcionando
**üèóÔ∏è STORAGE MODULARIZADO**: Nueva arquitectura para servicios de storage
**üß™ 100% TESTEABLE**: Cada servicio independiente y mockeable
**üîÑ BACKWARD COMPATIBLE**: APIs MCP sin cambios
**‚úÖ CLEAN COMPILATION**: 0 errores TypeScript

#### **üéØ CAPAS Y SERVICIOS IMPLEMENTADOS**

#### **üè¢ Presentation Layer (Adapters) - MODULAR SYSTEM**
- ‚úÖ **MCP Adapter** (`src/adapters/mcp.ts`) - Protocolo MCP con routing a handlers
- ‚úÖ **MCPHandlers** (`src/adapters/mcp-handlers.ts`) - Orquestador central con delegation
- ‚úÖ **MarketDataHandlers** (`src/adapters/handlers/marketDataHandlers.ts`) - Handlers especializados
- ‚úÖ **AnalysisRepositoryHandlers** (`src/adapters/handlers/analysisRepositoryHandlers.ts`) - TASK-009 FASE 3
- ‚úÖ **CacheHandlers** (`src/adapters/cacheHandlers.ts`) - Operaciones de cache
- üîÆ **REST API Adapter** (Futuro) - FastAPI integration ready
- üîÆ **WebSocket Adapter** (Futuro) - Real-time streams
- üîÆ **CLI Adapter** (Futuro) - Command line interface

#### **üß† Core Layer (Business Logic)**
- ‚úÖ **Market Analysis Engine** (`src/core/engine.ts`) - Orquestador principal
- ‚úÖ **System Configuration** - Configuraci√≥n centralizada
- ‚úÖ **Health Monitoring** - Estado del sistema
- ‚úÖ **Performance Tracking** - M√©tricas autom√°ticas
- ‚úÖ **Analysis Repository Integration** - FASE 3 completa

#### **‚öôÔ∏è Service Layer (Specialized Services)**
- ‚úÖ **Market Data Service** (`src/services/marketData.ts`) - Bybit API integration
- ‚úÖ **Technical Analysis Service** (`src/services/analysis.ts`) - An√°lisis t√©cnico
- ‚úÖ **Trading Service** (`src/services/trading.ts`) - Grid trading & strategies
- ‚úÖ **Storage Service** (`src/services/storage/`) - Sistema modularizado nuevo
- ‚úÖ **Cache Manager** (`src/services/cacheManager.ts`) - Cache con TTL
- ‚úÖ **Analysis Repository** (`src/repositories/analysisRepository.ts`) - Gesti√≥n de an√°lisis
- üîÆ **Multi-Exchange Services** (Futuro) - Binance, Coinbase, etc.

#### **üõ†Ô∏è Utility Layer (Common Tools)**
- ‚úÖ **Logger** (`src/utils/logger.ts`) - Sistema de logs estructurado
- ‚úÖ **Performance Monitor** (`src/utils/performance.ts`) - M√©tricas de rendimiento
- ‚úÖ **Math Utils** (`src/utils/math.ts`) - Utilidades matem√°ticas
- ‚úÖ **Type Definitions** (`src/types/index.ts`) - Tipos centralizados

#### **üî• PATR√ìN DE MODULARIDAD v1.3.7 - DELEGATION ARCHITECTURE**

##### **‚úÖ Sistema de Handlers Especializado**
```typescript
// MCPHandlers act√∫a como coordinador central
export class MCPHandlers {
  private marketDataHandlers: MarketDataHandlers;
  private analysisRepositoryHandlers: AnalysisRepositoryHandlers;
  private cacheHandlers: CacheHandlers;
  
  // Delegation to specialized handlers
  async handleGetTicker(args: any) {
    return await this.marketDataHandlers.handleGetTicker(args);
  }
}
```

##### **‚úÖ MCP Adapter Simplificado**
- **Eliminado c√≥digo duplicado**: 2000+ l√≠neas reducidas a ~500 l√≠neas limpias
- **Routing limpio**: Switch simple que delega a handlers especializados
- **Mantenimiento sencillo**: Cambios localizados en handlers espec√≠ficos

##### **‚úÖ Handlers Especializados por Dominio**
- **MarketDataHandlers**: `handleGetTicker`, `handleGetOrderbook`, `handleGetMarketData`
- **AnalysisRepositoryHandlers**: TASK-009 FASE 3 handlers completos (7 herramientas)
- **CacheHandlers**: `handleGetCacheStats`, `handleClearCache`, `handleInvalidateCache`

### üéØ Funcionalidades IMPLEMENTADAS v1.4.0 (SISTEMA COMPLETO + TESTS)

#### **üèóÔ∏è ARQUITECTURA & INFRAESTRUCTURA**
- ‚úÖ **üéÜ ARQUITECTURA MODULAR REPARADA** - Sistema de handlers completamente funcional
- ‚úÖ **Delegation pattern** - MCPHandlers coordina handlers especializados
- ‚úÖ **Handlers por dominio** - MarketData, AnalysisRepository, Cache, ReportGenerator separados
- ‚úÖ **Compilaci√≥n limpia** - 0 errores TypeScript
- ‚úÖ **Separation of concerns** - Cada handler con responsabilidad espec√≠fica
- ‚úÖ **TASK-009 FASE 4 COMPLETA** - Report Generator con 8 herramientas operativas
- ‚úÖ **TASK-004 TESTS CONFIGURADOS** - Sistema completo de tests unitarios
- ‚úÖ **Storage Service Modularizado** - FileSystem + PatternMatcher + Config
- ‚úÖ **100% Testeable** - Cada servicio mockeable independientemente
- ‚úÖ **Performance optimizado** - Eliminado c√≥digo duplicado masivo
- ‚úÖ **Engine API Expandido** - M√©todos granulares getTicker, getOrderbook, getKlines

#### **üì¶ TASK-009 STORAGE SYSTEM (100% COMPLETO)**
- ‚úÖ **FASE 1: StorageService Base** - Operaciones CRUD funcionando
- ‚úÖ **FASE 2: Cache Manager** - In-memory cache con TTL y LRU
- ‚úÖ **FASE 3: Analysis Repository** - 7 herramientas MCP operativas:
  - `get_analysis_by_id` - Buscar por UUID
  - `get_latest_analysis` - √öltimo an√°lisis por tipo
  - `search_analyses` - B√∫squeda compleja
  - `get_analysis_summary` - Resumen agregado
  - `get_aggregated_metrics` - M√©tricas estad√≠sticas
  - `find_patterns` - Buscar patrones
  - `get_repository_stats` - Estad√≠sticas del repo
- ‚úÖ **FASE 4: Report Generator** - 8 herramientas MCP operativas:
  - `generate_report` - Generar reporte personalizado
  - `generate_daily_report` - Reporte diario autom√°tico
  - `generate_weekly_report` - Reporte semanal
  - `generate_symbol_report` - Reporte por s√≠mbolo
  - `generate_performance_report` - An√°lisis de rendimiento
  - `get_report` - Obtener reporte por ID
  - `list_reports` - Listar reportes disponibles
  - `export_report` - Exportar reporte a archivo

#### **üîç SISTEMA DE LOGGING Y DEBUGGING OPTIMIZADO**
- ‚úÖ **API Statistics b√°sicos** - Total requests, errors, success rate en memoria
- ‚úÖ **Error tracking simple** - √öltimos 5 errores con timestamp
- ‚úÖ **Connection monitoring** - Status HTTP, timeouts, parsing errors
- ‚úÖ **Zero complex objects** - Eliminados objetos que causaban errores JSON
- ‚úÖ **Claude Desktop compatible** - Sin errores molestos en UI
- ‚úÖ **Performance b√°sico** - Duraci√≥n de requests sin overhead
- ‚úÖ **Essential debugging** - Solo lo necesario para troubleshooting
- ‚úÖ **Production ready** - Sistema estable sin logs verbosos

#### **üìä FUNCIONALIDADES DE AN√ÅLISIS**
- ‚úÖ **Market Data Service** - Ticker, orderbook, klines con error handling
- ‚úÖ **Technical Analysis Service** - Volatilidad, volumen, Volume Delta, S/R
- ‚úÖ **Trading Service** - Grid trading inteligente basado en volatilidad
- ‚úÖ **Support/Resistance avanzado** - Algoritmo multi-factor con scoring
- ‚úÖ **Volume Delta aproximado** - Presi√≥n compradora/vendedora sin API key
- ‚úÖ **Divergence detection** - Detecci√≥n temprana de reversiones
- ‚úÖ **VWAP integration** - An√°lisis de valor promedio ponderado

#### **üîß SISTEMA DE DESARROLLO**
- ‚úÖ **Sistema de logs estructurado** - Logger con diferentes niveles
- ‚úÖ **Performance tracking** - M√©tricas de ejecuci√≥n autom√°ticas
- ‚úÖ **Error handling robusto** - Try/catch en todas las capas
- ‚úÖ **Build system** - TypeScript compilation sin errores
- ‚úÖ **Development tools** - ESLint, TypeDoc, Jest configurados

### En DESARROLLO ACTIVO v1.4.0
- ‚úÖ **TASK-009 COMPLETADA** - Sistema Storage completo con 4 fases implementadas
- ‚úÖ **TASK-004 COMPLETADA** - Tests unitarios configurados y funcionando
- üöÄ **PR√ìXIMAS TAREAS**:
  - **TASK-012** - Detecci√≥n Trampas Alcistas/Bajistas (7h)
  - **TASK-013** - On-chain Data Collection (15h)
  - **TASK-015** - Dual Storage MongoDB Experimental (6h)
  - **TASK-016** - Migraci√≥n MongoDB Completa (8-12h, condicional)
  - **TASK-010** - Sistema Configuraci√≥n Timezone (4h)
- üìÑ **Documentaci√≥n** - Sistema completo documentado y listo
- üóÉÔ∏è **MongoDB Evaluation** - Dual storage para evaluar beneficios vs complejidad

### NUEVAS FUNCIONALIDADES PLANIFICADAS v1.4.0
- üéØ **TASK-012** - Detecci√≥n Trampas Alcistas/Bajistas (7h) - Bull/bear trap detection
- üîó **TASK-013** - On-chain Data Collection (15h) - Stablecoins, ballenas, exchanges
- üóÉÔ∏è **TASK-015** - Dual Storage MongoDB Experimental (6h) - Evaluar beneficios sin romper sistema
- üîÑ **TASK-016** - Migraci√≥n MongoDB Completa (8-12h) - Solo si TASK-015 exitoso
- üìù **TASK-010** - Sistema Configuraci√≥n Timezone (4h) - Eliminar friction temporal
- üè¢ **FastAPI Scope** - An√°lisis Macro + ML (77h) - Documentado para desarrollo futuro

### NO EXISTE (no sugerir a√∫n)
- ‚ùå Funciones que requieren API Key
- ‚ùå Trading automatizado
- ‚ùå Gesti√≥n de √≥rdenes
- ‚ùå Portfolio tracking

### Integraci√≥n con Waickoff AI
- Este MCP servir√° como capa de datos para Waickoff
- Mantener separaci√≥n: MCP = datos, Waickoff = inteligencia
- Futuro: m√∫ltiples MCPs (Binance, etc.) alimentando Waickoff

### WORKFLOW v1.3.9 para BUGS CR√çTICOS:
1. **Detectar y documentar** en `claude/bugs/bug-XXX-description.md`
2. **Analizar root cause** con detalles t√©cnicos
3. **Implementar fix** siguiendo arquitectura actual
4. **Actualizar logs** con cambios realizados
5. **Crear tests** para evitar regresi√≥n (TASK-004 urgente)
6. **Compilar y validar** antes de declarar resuelto

### WORKFLOW v1.3.9 para DESARROLLO MODULAR (ACTUALIZADO):
1. **Leer arquitectura**: Este archivo + `claude/master-log.md` para estado actual
2. **Identificar capa/servicio**: Presentation/Core/Service/Utility
3. **Para nuevos servicios**: Crear interfaces primero (`I*Service`)
4. **Modularizar si es complejo**: Dividir en servicios especializados (como Storage)
5. **Seguir delegation pattern**: Para handlers MCP
6. **Testing modular**: Cada servicio debe ser mockeable
7. **Compilar y validar**: TypeScript + tests antes de declarar completado

### REGLAS C√ìDIGO v1.3.9 (ARQUITECTURA MODULAR - OBLIGATORIO):

### ‚ö†Ô∏è REGLAS CR√çTICAS DE DOCUMENTACI√ìN:
1. **NO CREAR DOCUMENTACI√ìN** sin visto bueno expl√≠cito del usuario
2. **NO INVENTAR FUNCIONALIDAD** - Siempre analizar c√≥digo existente primero
3. **VERIFICAR COMPILACI√ìN** antes de declarar algo como completado
4. **PREGUNTAR ANTES DE ASUMIR** - Si algo no est√° claro, preguntar
5. **C√ìDIGO PRIMERO** - La implementaci√≥n es la prioridad, no la documentaci√≥n

### REGLAS C√ìDIGO v1.3.8 (ARQUITECTURA MODULAR - OBLIGATORIO):
1. **TypeScript estricto** - Tipos definidos, interfaces implementadas
2. **Dependency injection** - Servicios inyectados por constructor
3. **Interface segregation** - Implementar `I*Service` interfaces
4. **Performance monitoring** - Wrapper autom√°tico en servicios
5. **Error handling** - Try/catch en todas las funciones
6. **Separation of concerns** - Cada clase una responsabilidad
7. **Backward compatibility** - No romper APIs MCP existentes
8. **Documentation** - JSDoc en interfaces y m√©todos p√∫blicos
9. **Modularizaci√≥n** - Si un servicio > 300 l√≠neas, considerar dividirlo
10. **Path normalization** - Siempre normalizar a forward slashes para patterns

### Comandos de desarrollo (v1.3.9):
```bash
npm run build      # Compilar TypeScript modular
npm run dev        # Modo desarrollo con watch
npm start          # Ejecutar MCP compilado
npm run clean      # Limpiar build
npm run test       # Ejecutar tests unitarios (TASK-004)
npm run lint       # Verificar c√≥digo con ESLint
npm run docs       # Generar documentaci√≥n con TypeDoc
```

### Configuraci√≥n Claude Desktop:
```json
{
  "mcpServers": {
    "waickoff-mcp": {
      "command": "node",
      "args": ["D:\\projects\\mcp\\waickoff_mcp\\build\\index.js"],
      "env": {}
    }
  }
}
```

### FILOSOF√çA v1.3.9 (MODULARIDAD + PRODUCTION READY):
- **"Divide y vencer√°s"** - Servicios especializados sobre monolitos
- **"Pattern matching robusto"** - Cross-platform sin sorpresas
- **"Zero Errors UX"** - Claude Desktop sin errores molestos
- **"Testeable por dise√±o"** - Cada m√≥dulo independiente
- **"Ready for Scale"** - Arquitectura que crece sin dolor
- **"Separation of Concerns"** - Cada servicio una responsabilidad
- **"User Experience First"** - Funcionalidad robusta sin fricci√≥n

## üéØ ENFOQUE ACTUAL v1.3.9: SISTEMA LIMPIO Y UNIFICADO
**‚úÖ TASK-014 COMPLETADA**: Auto-save legacy eliminado - un solo sistema de guardado
**‚úÖ BUG-004 RESUELTO**: Pattern matching funcionando perfectamente
**‚úÖ STORAGE MODULARIZADO**: FileSystem + PatternMatcher + Config services
**üéØ 7 HERRAMIENTAS OPERATIVAS**: Analysis Repository 100% funcional
**üîÆ PR√ìXIMA DECISI√ìN**: FASE 4 Report Generator vs TASK-012 Bull/Bear Traps

**REFERENCIAS CR√çTICAS v1.3.9**: 
- **Arquitectura completa**: `claude/docs/architecture/system-overview.md`
- **Storage refactorizado**: `src/services/storage/` (nueva estructura)
- **Bug resuelto**: `claude/bugs/bug-004-storage-query-pattern.md`
- **APIs actualizadas**: `claude/docs/api/tools-reference.md`
- **Tipos centralizados**: `src/types/index.ts`
- **Core engine**: `src/core/engine.ts`

## üìã OBLIGATORIO AL TERMINAR CUALQUIER TRABAJO (v1.3.9):
1. **Actualizar tipos centralizados** en `src/types/index.ts` si es necesario
2. **Verificar interfaces** implementadas correctamente
3. **Actualizar documentaci√≥n** de arquitectura si hay cambios estructurales
4. **Crear documentaci√≥n en claude/docs/** para features completadas
5. **Performance metrics** verificar que est√©n funcionando
6. **Tests unitarios** crear/actualizar para nuevos servicios
7. **Backward compatibility** verificar que MCP siga funcionando
8. **Build limpio** sin errores TypeScript
9. **Documentar decisiones** t√©cnicas importantes en logs
10. **Path normalization** verificar consistencia cross-platform

**üéÜ SISTEMA v1.3.9 - C√ìDIGO LIMPIO Y UNIFICADO**

**‚úÖ BUG-004 RESUELTO**: StorageService pattern matching arreglado
**üèóÔ∏è STORAGE MODULARIZADO**: FileSystem + PatternMatcher + Config  
**üí™ 7 HERRAMIENTAS NUEVAS**: Analysis Repository 100% operativo
**üîÆ 85% COMPLETADO**: Solo falta Report Generator para cerrar TASK-009
**üßπ C√ìDIGO LIMPIO**: Auto-save legacy eliminado, un solo sistema de guardado
